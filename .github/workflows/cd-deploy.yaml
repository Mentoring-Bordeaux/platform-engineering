name: ci-deploy

on:
  workflow_run:
    workflows: ["ci-build"]
    types:
      - completed

env:
  IMAGE_TAG: ${{ github.sha }}
  # ⚠️ Mettez les vrais noms créés par Pulumi :
  APP_NAME_API: mono-api             # Container App (backend)
  WEBAPP_NAME: mono-app-web          # Web App for Containers (frontend)
  WEBSITES_PORT: "3000"              # Port exposé par l'image du front (Nuxt SSR typiquement 3000)
  RG: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  build-and-push-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Docker login to ACR
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" \
          | docker login ${{ secrets.ACR_LOGIN_SERVER }} \
            -u ${{ secrets.ACR_USERNAME }} --password-stdin

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      # --- Build & push API image ---
      - name: Build & push API image
        uses: docker/build-push-action@v6
        with:
          context: ./api
          file: Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/mono/api:${{ env.IMAGE_TAG }}
            ${{ secrets.ACR_LOGIN_SERVER }}/mono/api:latest

      # --- Build & push Front image ---
      - name: Build & push APP image
        uses: docker/build-push-action@v6
        with:
          context: ./app
          file: Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/mono/app:${{ env.IMAGE_TAG }}
            ${{ secrets.ACR_LOGIN_SERVER }}/mono/app:latest

      - name: Export image tags for downstream jobs
        run: |
          echo "API_IMAGE=${{ secrets.ACR_LOGIN_SERVER }}/mono/api:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV
          echo "APP_IMAGE=${{ secrets.ACR_LOGIN_SERVER }}/mono/app:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV

  deploy-api-aca:
    needs: build-and-push-images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update API image on Container App (new revision)
        uses: azure/cli@v2
        with:
          inlineScript: |
            az extension add --name containerapp --upgrade
            az containerapp update \
              -g "${{ env.RG }}" \
              -n "${{ env.APP_NAME_API }}" \
              --image "${{ env.API_IMAGE }}" \
              --revision-suffix "${{ github.sha }}"
            echo "API URL:"
            az containerapp show -g "${{ env.RG }}" -n "${{ env.APP_NAME_API }}" \
              --query properties.configuration.ingress.fqdn -o tsv

  deploy-frontend-webapp:
    needs: build-and-push-images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Si Pulumi a déjà lié le Web App à ACR (Managed Identity), pas besoin d'user/pass.
      - name: Point Web App to new image
        uses: azure/cli@v2
        with:
          inlineScript: |
            az webapp config container set \
              --resource-group "${{ env.RG }}" \
              --name "${{ env.WEBAPP_NAME }}" \
              --docker-custom-image-name "${{ env.APP_IMAGE }}"
            az webapp config appsettings set \
              --resource-group "${{ env.RG }}" \
              --name "${{ env.WEBAPP_NAME }}" \
              --settings WEBSITES_PORT=${{ env.WEBSITES_PORT }}
            # (Optionnel) si vous avez besoin d'une commande de démarrage spécifique :
            # az webapp config set --resource-group "${{ env.RG }}" --name "${{ env.WEBAPP_NAME }}" --startup-file "node .output/server/index.mjs"
            az webapp restart --resource-group "${{ env.RG }}" --name "${{ env.WEBAPP_NAME }}"
            echo "Front URL:"
            az webapp show -g "${{ env.RG }}" -n "${{ env.WEBAPP_NAME }}" --query defaultHostName -o tsv
