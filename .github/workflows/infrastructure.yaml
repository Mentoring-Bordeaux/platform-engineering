name: infrastructure

on:
  pull_request:
    branches: [main, feature/pipelines]
    paths:
      - 'api/**'
      - 'app/**'
      - 'infrastructure/**'
      - '.github/workflows/**'

  push:
    branches: [main, feature/pipelines]
    paths:
      - 'api/**'
      - 'app/**'
      - 'infrastructure/**'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  preview:
    environment: development
    # Only run preview when the PR is from the same repository (secrets + OIDC available)
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: infrastructure/package.json

      - name: Enable pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Install dependencies
        if: hashFiles('infrastructure/pnpm-lock.yaml') != ''
        run: pnpm install --frozen-lockfile

      - name: Build TypeScript (if script present)
        run: pnpm run --if-present build

      - name: Pulumi Auth
        uses: pulumi/auth-actions@v1
        with:
          organization: teachingiac
          requested-token-type: urn:pulumi:token-type:access_token:team
          scope: team:Enseirb_students

      - name: Pulumi Preview
        uses: pulumi/actions@v6
        with:
          command: preview
          stack-name: teachingiac/platform-engineering-infra/dev
          work-dir: infrastructure

  update:
    environment: development
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: infrastructure/package.json

      - name: Enable pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Install dependencies
        if: hashFiles('infrastructure/pnpm-lock.yaml') != ''
        run: pnpm install --frozen-lockfile

      - name: Allow non-interactive Pulumi up
        run: echo "PULUMI_YES=1" >> $GITHUB_ENV

      - name: Build TypeScript (if script present)
        run: pnpm run --if-present build
      
      - name: Pulumi Auth
        uses: pulumi/auth-actions@v1
        with:
          organization: teachingiac
          requested-token-type: urn:pulumi:token-type:access_token:team
          scope: team:Enseirb_students

      - name: Pulumi Up
        uses: pulumi/actions@v6
        with:
          command: up
          stack-name: teachingiac/platform-engineering-infra/dev
          work-dir: infrastructure

      - name: Export Pulumi outputs
        run: |
          pulumi stack output --json > outputs.json
          cat outputs.json | jq -r 'to_entries|.[]|"\(.key)=\(.value)"' > infra.outputs.env
          cat infra.outputs.env

      - name: Upload infra outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: infra-outputs
          path: infrastructure/infra.outputs.env
          retention-days: 3


