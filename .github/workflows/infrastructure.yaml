  name: infrastructure

  on:
    pull_request:
      branches: [ main ]
      paths:
        - "infrastructure/**"
        - ".github/workflows/infra.yml"
    push:
      branches: [ main ]
      paths:
        - "infrastructure/**"
        - ".github/workflows/infra.yml"
    workflow_dispatch:

  jobs:
    pulumi:
      runs-on: ubuntu-latest
      defaults:
        run:
          working-directory: infrastructure
      steps:
        - uses: actions/checkout@v4

        - name: Azure Login
          uses: azure/login@v2
          with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}

        - name: Setup Node (si infra en TS/Node)
          uses: actions/setup-node@v4
          with:
            node-version: '20'

        - name: Setup pnpm
          uses: pnpm/action-setup@v4
          with:
            version: 9
            run_install: false

        - name: Install deps
          if: hashFiles('infrastructure/pnpm-lock.yaml') != ''
          run: pnpm install --frozen-lockfile

        - name: Setup Pulumi
          uses: pulumi/actions@v5
          with:
            pulumi-version: '3.x'
          env:
            PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

        - name: Select stack
          run: |
            pulumi stack select ${{ secrets.PULUMI_STACK || 'prod' }} --create

        - name: Pulumi Preview (PR)
          if: github.event_name == 'pull_request'
          run: pulumi preview --diff --non-interactive

        - name: Pulumi Up (main / manual)
          if: github.event_name != 'pull_request'
          run: pulumi up --yes --skip-preview

        # ðŸ‘‰ Export Pulumi outputs to a .env-style file
        - name: Export Pulumi outputs
          if: github.event_name != 'pull_request'
          run: |
            pulumi stack output --json > outputs.json
            cat outputs.json | jq -r 'to_entries|.[]|"\(.key)=\(.value)"' > infra.outputs.env
            echo "Generated infra.outputs.env:"
            cat infra.outputs.env
        
        # ðŸ‘‰ Upload artifact for downstream workflows
        - name: Upload infra outputs
          if: github.event_name != 'pull_request'
          uses: actions/upload-artifact@v4
          with:
            name: infra-outputs
            path: infrastructure/infra.outputs.env
            retention-days: 3


